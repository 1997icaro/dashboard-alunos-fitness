<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Acompanhamento de Alunos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Cor de fundo suave */
            color: #333;
            line-height: 1.6;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 320px; /* Altura fixa para os gráficos */
            max-height: 400px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 1.5rem;
            color: #666;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6; /* Cor azul do Tailwind */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none !important;
        }
        /* Estilos para o modal de mensagem */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .modal-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            margin-top: 1rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-8 px-4">

    <!-- Overlay de Carregamento -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Carregando dados dos alunos...</p>
    </div>

    <!-- Modal de Mensagem (oculto por padrão) -->
    <div id="message-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="modal-message" class="text-lg mb-4"></p>
            <button id="modal-ok-button" class="modal-button">OK</button>
        </div>
    </div>

    <!-- Conteúdo Principal do Dashboard -->
    <div id="dashboard-content" class="container mx-auto bg-white p-6 rounded-xl shadow-lg w-full max-w-6xl hidden">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Dashboard de Acompanhamento</h1>
        <p class="text-center text-gray-600 mb-8">Análise de Progresso e Bem-Estar do Aluno</p>

        <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-8 mb-8">
            <div class="flex items-center space-x-2">
                <label for="student-select" class="text-lg font-medium text-gray-700">Aluno:</label>
                <select id="student-select" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-800">
                    <option value="">Nenhum aluno encontrado</option>
                </select>
            </div>
            <div class="text-lg font-medium text-gray-700">
                Período de Análise: <span id="analysis-period" class="font-semibold text-blue-600">Últimas 8 Semanas</span>
            </div>
        </div>

        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Resumo da Última Semana</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <div class="bg-blue-50 p-4 rounded-lg shadow-sm text-center">
                    <p class="text-gray-600">Peso Atual</p>
                    <p id="current-weight" class="text-3xl font-bold text-blue-700 mt-1">-- kg</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg shadow-sm text-center">
                    <p class="text-gray-600">Treinos Feitos</p>
                    <p id="workouts-done" class="text-3xl font-bold text-green-700 mt-1">--</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg shadow-sm text-center">
                    <p class="text-gray-600">Score de Sono</p>
                    <p id="sleep-score" class="text-3xl font-bold text-purple-700 mt-1">--/5</p>
                </div>
                <div class="bg-red-50 p-4 rounded-lg shadow-sm text-center">
                    <p class="text-gray-600">Score de Estresse</p>
                    <p id="stress-score" class="text-3xl font-bold text-red-700 mt-1">--/5</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg shadow-sm text-center">
                    <p class="text-gray-600">Score de Motivação</p>
                    <p id="motivation-score" class="text-3xl font-bold text-yellow-700 mt-1">--/5</p>
                </div>
            </div>
        </section>

        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Evolução Corporal</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-700 mb-2">Evolução do Peso (kg)</h3>
                    <p class="text-gray-500 text-sm mb-4">Acompanhamento do peso ao longo das semanas. A linha de tendência mostra o progresso na redução ou manutenção do peso.</p>
                    <div class="chart-container">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-700 mb-2">Evolução das Medidas (cm)</h3>
                    <p class="text-gray-500 text-sm mb-4">Redução ou variação das medidas corporais ao longo do tempo, permitindo visualizar o impacto do treino e dieta.</p>
                    <div class="chart-container">
                        <canvas id="measurementsChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Histórico de Treinos e Bem-Estar</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-700 mb-2">Treinos Realizados por Semana</h3>
                    <p class="text-gray-500 text-sm mb-4">Visualização da consistência nos treinos semanais.</p>
                    <div class="chart-container">
                        <canvas id="workoutsChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-700 mb-2">Score de Bem-Estar (Sono, Estresse, Motivação)</h3>
                    <p class="text-gray-500 text-sm mb-4">Análise combinada dos fatores de bem-estar ao longo do tempo.</p>
                    <div class="chart-container">
                        <canvas id="wellbeingChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Feedback e Observações</h2>
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <div id="feedback-content" class="text-gray-700">
                    <p class="text-gray-500">Nenhum feedback disponível para este aluno.</p>
                </div>
            </div>
        </section>
    </div>

    <script>
        // COLOQUE AQUI O URL DO SEU GOOGLE APPS SCRIPT QUE VOCÊ COPIOU NO PASSO 4!
        // O URL deve começar com 'https://script.google.com/macros/s/...'
        const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx0Mrn2u4Cp9175l2gvuhsUL8y0MAIBGt4LUDYlK-IuKnc820AdC4b8OsY2RITi77c_pQ/exec'; // Substitua por seu URL real

        let allStudentData = []; // Este objeto será preenchido com os dados reais
        let weightChart, measurementsChart, workoutsChart, wellbeingChart;

        // Função para formatar a data para exibição
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Função para exibir o modal de mensagem
        function showMessageModal(message) {
            const modalOverlay = document.getElementById('message-modal');
            const modalMessage = document.getElementById('modal-message');
            modalMessage.textContent = message;
            modalOverlay.classList.remove('hidden');
        }

        // Função para fechar o modal de mensagem
        document.getElementById('modal-ok-button').addEventListener('click', () => {
            document.getElementById('message-modal').classList.add('hidden');
        });

        // Função principal para carregar os dados
        async function loadStudentData() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const dashboardContent = document.getElementById('dashboard-content');
            
            loadingOverlay.classList.remove('hidden');
            dashboardContent.classList.add('hidden');

            try {
                // Verifica se o URL do Apps Script foi configurado
                if (APPS_SCRIPT_WEB_APP_URL === 'COLE_SEU_URL_DO_APPS_SCRIPT_AQUI' || !APPS_SCRIPT_WEB_APP_URL) {
                    showMessageModal('Por favor, configure o URL do Google Apps Script no código HTML.');
                    loadingOverlay.querySelector('p').textContent = 'Erro: URL do App Script não configurado.';
                    return;
                }

                const response = await fetch(APPS_SCRIPT_WEB_APP_URL);
                const rawData = await response.json();

                if (rawData.error) {
                    showMessageModal(`Erro ao carregar dados: ${rawData.error}`);
                    loadingOverlay.querySelector('p').textContent = `Erro: ${rawData.error}`;
                    return;
                }

                if (!Array.isArray(rawData) || rawData.length === 0) {
                    showMessageModal('Nenhum dado de aluno encontrado na planilha. Verifique sua planilha e o Apps Script.');
                    loadingOverlay.querySelector('p').textContent = 'Nenhum dado encontrado.';
                    return;
                }

                // Mapeia os dados para os nomes esperados pelo dashboard
                allStudentData = rawData.map(entry => {
                    // Ajuste os nomes das chaves para corresponderem EXATAMENTE ao que o Apps Script está a enviar
                    // Baseado no JSON que você me forneceu:
                    const mappedEntry = {
                        carimboDataHora: entry.carimboDataHora,
                        nomeCompleto: entry.seunomecompleto, // Ajustado
                        dataResposta: entry.dataResposta,
                        pesoAtual: parseFloat(entry.pesoAtual),
                        tirouMedidas: entry.voctiroumedidasessasemana, // Ajustado
                        abdominal: parseFloat(entry.abdominalemcm), // Ajustado
                        cintura: parseFloat(entry.cinturaemcm),     // Ajustado
                        coxa: parseFloat(entry.coxasemcm),         // Ajustado
                        sono: parseInt(entry.qualfoiaqualidadedosonoessasemana15), // Ajustado
                        estresse: parseInt(entry.nveldeestressenasemana15),     // Ajustado
                        motivacao: parseInt(entry.comoestsuamotivaoparatreinar15), // Ajustado
                        seguiuTreino: entry.seguiuotreinopropostonoapp, // Ajustado
                        treinosFeitos: entry.quantostreinosvocfezestasemana, // Ajustado
                        feedback: entry.algoquequeiramecontarouperguntar // Ajustado
                    };

                    // Converte strings de data para objetos Date para facilitar a ordenação e manipulação
                    if (mappedEntry.carimboDataHora) {
                        mappedEntry.carimboDataHora = new Date(mappedEntry.carimboDataHora);
                    }
                    if (mappedEntry.dataResposta) {
                        mappedEntry.dataResposta = new Date(mappedEntry.dataResposta);
                    }

                    return mappedEntry;
                });

                // Filtra e ordena os dados
                allStudentData = allStudentData.filter(entry => entry.nomeCompleto && entry.nomeCompleto.trim() !== '');
                allStudentData.sort((a, b) => a.carimboDataHora - b.carimboDataHora);

                populateStudentSelect();
                updateDashboard(); // Atualiza com o primeiro aluno por padrão ou vazio
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showMessageModal(`Erro ao carregar dados: ${error.message}. Verifique o console para detalhes.`);
                loadingOverlay.querySelector('p').textContent = `Erro de rede ou processamento.`;
            } finally {
                loadingOverlay.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
            }
        }

        // Preenche o seletor de alunos
        function populateStudentSelect() {
            const studentSelect = document.getElementById('student-select');
            studentSelect.innerHTML = ''; // Limpa opções existentes

            const uniqueStudents = [...new Set(allStudentData.map(entry => entry.nomeCompleto))];
            
            if (uniqueStudents.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhum aluno encontrado';
                studentSelect.appendChild(option);
                studentSelect.disabled = true;
            } else {
                studentSelect.disabled = false;
                uniqueStudents.forEach(studentName => {
                    const option = document.createElement('option');
                    option.value = studentName;
                    option.textContent = studentName;
                    studentSelect.appendChild(option);
                });
                // Seleciona o primeiro aluno por padrão
                studentSelect.value = uniqueStudents[0];
            }

            studentSelect.addEventListener('change', updateDashboard);
        }

        // Atualiza o dashboard com os dados do aluno selecionado
        function updateDashboard() {
            const studentSelect = document.getElementById('student-select');
            const selectedStudentName = studentSelect.value;

            if (!selectedStudentName) {
                // Limpa o dashboard se nenhum aluno for selecionado
                document.getElementById('current-weight').textContent = '-- kg';
                document.getElementById('workouts-done').textContent = '--';
                document.getElementById('sleep-score').textContent = '--/5';
                document.getElementById('stress-score').textContent = '--/5';
                document.getElementById('motivation-score').textContent = '--/5';
                document.getElementById('feedback-content').innerHTML = '<p class="text-gray-500">Nenhum feedback disponível para este aluno.</p>';
                if (weightChart) weightChart.destroy();
                if (measurementsChart) measurementsChart.destroy();
                if (workoutsChart) workoutsChart.destroy();
                if (wellbeingChart) wellbeingChart.destroy();
                return;
            }

            const studentEntries = allStudentData.filter(entry => entry.nomeCompleto === selectedStudentName);

            // Ordena as entradas do aluno pela data para gráficos de evolução
            studentEntries.sort((a, b) => a.carimboDataHora - b.carimboDataHora);

            // Resumo da Última Semana
            const latestEntry = studentEntries[studentEntries.length - 1]; // Última entrada
            if (latestEntry) {
                document.getElementById('current-weight').textContent = `${latestEntry.pesoAtual || '--'} kg`;
                document.getElementById('workouts-done').textContent = latestEntry.treinosFeitos || '--';
                document.getElementById('sleep-score').textContent = `${latestEntry.sono || '--'}/5`;
                document.getElementById('stress-score').textContent = `${latestEntry.estresse || '--'}/5`;
                document.getElementById('motivation-score').textContent = `${latestEntry.motivacao || '--'}/5`;
                
                const feedbackHtml = latestEntry.feedback && latestEntry.feedback.trim() !== '' 
                                     ? `<p>${latestEntry.feedback}</p>` 
                                     : '<p class="text-gray-500">Nenhum feedback disponível para este aluno.</p>';
                document.getElementById('feedback-content').innerHTML = feedbackHtml;
            } else {
                // Se não houver entradas válidas, limpa o resumo
                document.getElementById('current-weight').textContent = '-- kg';
                document.getElementById('workouts-done').textContent = '--';
                document.getElementById('sleep-score').textContent = '--/5';
                document.getElementById('stress-score').textContent = '--/5';
                document.getElementById('motivation-score').textContent = '--/5';
                document.getElementById('feedback-content').innerHTML = '<p class="text-gray-500">Nenhum feedback disponível para este aluno.</p>';
            }

            // Gráficos de Evolução
            renderCharts(studentEntries);
        }

        function renderCharts(entries) {
            const labels = entries.map(entry => formatDate(entry.carimboDataHora));

            // Gráfico de Peso
            if (weightChart) weightChart.destroy();
            const weightCtx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(weightCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Peso (kg)',
                        data: entries.map(entry => entry.pesoAtual),
                        borderColor: '#6366f1', // Indigo 500
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 5,
                        pointBackgroundColor: '#6366f1',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Peso (kg)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Peso: ${context.raw} kg`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de Medidas
            if (measurementsChart) measurementsChart.destroy();
            const measurementsCtx = document.getElementById('measurementsChart').getContext('2d');
            measurementsChart = new Chart(measurementsCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Abdominal (cm)',
                            data: entries.map(entry => entry.abdominal),
                            borderColor: '#ef4444', // Red 500
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            tension: 0.3,
                            fill: false,
                            pointRadius: 4,
                        },
                        {
                            label: 'Cintura (cm)',
                            data: entries.map(entry => entry.cintura),
                            borderColor: '#3b82f6', // Blue 500
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            tension: 0.3,
                            fill: false,
                            pointRadius: 4,
                        },
                        {
                            label: 'Coxa (cm)',
                            data: entries.map(entry => entry.coxa),
                            borderColor: '#22c55e', // Green 500
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            tension: 0.3,
                            fill: false,
                            pointRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Medida (cm)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} cm`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de Treinos
            if (workoutsChart) workoutsChart.destroy();
            const workoutsCtx = document.getElementById('workoutsChart').getContext('2d');
            workoutsChart = new Chart(workoutsCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Treinos Feitos',
                        data: entries.map(entry => {
                            // Converte a string de treinos para número, tratando casos como "3 a 4 treinos essa semn"
                            const num = parseInt(entry.treinosFeitos);
                            return isNaN(num) ? 0 : num; // Retorna 0 se não for um número válido
                        }),
                        backgroundColor: '#f59e0b', // Amber 500
                        borderColor: '#d97706',
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Número de Treinos'
                            },
                            ticks: {
                                precision: 0 // Garante que os ticks sejam números inteiros
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Treinos: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de Bem-Estar (Radar Chart)
            if (wellbeingChart) wellbeingChart.destroy();
            const wellbeingCtx = document.getElementById('wellbeingChart').getContext('2d');
            const lastEntryWellbeing = entries[entries.length - 1]; // Pega a última entrada para o radar chart

            wellbeingChart = new Chart(wellbeingCtx, {
                type: 'radar',
                data: {
                    labels: ['Sono', 'Estresse', 'Motivação'],
                    datasets: [{
                        label: 'Score da Última Semana',
                        data: [
                            lastEntryWellbeing ? lastEntryWellbeing.sono : 0,
                            lastEntryWellbeing ? (6 - lastEntryWellbeing.estresse) : 0, // Inverte o score de estresse para que 1 seja "melhor"
                            lastEntryWellbeing ? lastEntryWellbeing.motivacao : 0
                        ],
                        backgroundColor: 'rgba(139, 92, 246, 0.4)', // Violet 500
                        borderColor: '#8b5cf6',
                        borderWidth: 2,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: false
                            },
                            suggestedMin: 0,
                            suggestedMax: 5,
                            ticks: {
                                display: false // Oculta os números dos ticks no radar
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.label === 'Estresse') {
                                        return label + (6 - context.raw) + '/5'; // Mostra o valor original de estresse
                                    }
                                    return label + context.raw + '/5';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Carrega os dados quando a página é carregada
        window.onload = loadStudentData;
    </script>
</body>
</html>